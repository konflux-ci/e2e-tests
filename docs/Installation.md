# Installation of AppStudio E2E Mode

The following will walk through the deployment of AppStudio E2E mode in Openshift CI Pull Requests jobs

## Prerequisites

Before deploying the tooling, you must have the following prepared

* An OpenShift 4.9 or higher Environment
* A machine from which to run the install (usually your laptop)
  * The OpenShift Command Line Tool (oc)
  * yq
  * jq
  * git
  * Github Token with the following permissions
    * `repo`
    * `delete_repo`
  * Valid quay token where to push AppStudio components images generated by the e2e framework

## Initial Deployment Steps

Before starting the deployment steps of appstudio in e2e mode in Openshift CI you should skip the first 2 steps

1. Access To Openshift Cluster.

2. Login to the cluster as `admin`

   ```bash
    oc login -u <user> -p <password> --server=<oc_api_url>
   ```

3. Install Red Hat App Studio in e2e mode. The e2e framework by default will use the `redhat-appstudio-qe` github organization by default. If u want to change the github org you should define `GITHUB_E2E_ORGANIZATION` environment with your custom github organization

   ```bash
      # In Openshift CI there are some example about how to use the installation script. See infra-deployments script https://github.com/redhat-appstudio/application-service/blob/main/.ci/oci-e2e-has.sh#L59
      $ROOT_DIR/scripts/install-appstudio-e2e-mode.sh install
   ```

4. Compile the e2e tests

   ```bash
    make build
   ```

5. Run the e2e tests

   ```bash
    `$ROOT_DIR/bin/e2e-appstudio`
   ```

Where are:

- `install` - Flag to indicate the installation. If the flag will not be present you can `source` the script and use the bash functions.

The following environments are used to launch the Red Hat AppStudio installation in e2e mode and the tests execution:

| Variable | Required | Explanation | Default Value |
|---|---|---|---|
| `GITHUB_TOKEN` | yes | A github token used to create AppStudio applications in github  | ''  |
| `QUAY_TOKEN` | yes | A quay token to push components images to quay.io. Note the quay token must be in base 64 format `ewogI3dJhdXRocyI6I...` | '' |
| `GITHUB_E2E_ORGANIZATION` | no | GitHub Organization where to create/push Red Hat AppStudio Applications  | `redhat-appstudio-qe`  |
| `QUAY_E2E_ORGANIZATION` | no | Quay organization where to push components containers | `redhat-appstudio-qe` |
| `E2E_APPLICATIONS_NAMESPACE` | no | Name of the namespace used for running HAS E2E tests | `appstudio-e2e-test` |

## Install e2e binary in openshift-ci and use pairing PRs feature

The e2e tests are executed against almost all App Studio repositories.

Sometimes when we have changes in App Studio we are introducing some breaking changes and the e2e will fail. To prevent this the e2e framework installation in openshift-ci support a new feature of pairing the PR opened against an App Studio repository with the e2e forks based in branch names. Before the e2e framework will be executed in openshift-ci, the logic automatically tries to pair a PR opened in some repo with a branch of the same name that
potentially could exists in the developer's fork of the e2e repository

Since the changes in the e2e repo sometimes require changes in some of the operator repositories at the same time, the logic that executes the e2e tests supports a feature of pairing the e2e PR with one other PR based on branch names. Before the e2e tests are executed in openshift-ci, the logic automatically tries to pair a PR opened for this (toolchain-e2e) repository with a branch of the same name that potentially could exist in any of the developerâ€™s fork of the operator repositories.

For example, if a developer with GH account `cooljohn` opens a PR (for application-service repo) from a branch `new-feature`, then the logic checks if there is a branch `new-feature` also in the `cooljohn/e2e-tests` fork and if exists will start to install the e2e framework from those branch

To install App Studio E2E framework in openshift-ci and use the pairing feature it is necessary to perform:

```bash
   $ROOT_DIR/scripts/e2e-openshift-ci.sh
```
